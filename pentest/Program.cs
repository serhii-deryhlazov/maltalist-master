using System;
using System.Threading.Tasks;

namespace MaltalistPentest
{
    class Program
    {
        static async Task Main(string[] args)
        {
            var apiBaseUrl = Environment.GetEnvironmentVariable("API_BASE_URL") ?? "http://localhost:5000";
            
            Console.WriteLine("╔════════════════════════════════════════╗");
            Console.WriteLine("║   Maltalisting Security Pentest Tool   ║");
            Console.WriteLine("╚════════════════════════════════════════╝");
            Console.WriteLine($"\nTarget API: {apiBaseUrl}\n");

            var tester = new AuthenticationSecurityTester(apiBaseUrl);
            
            try
            {
                await tester.TestDeleteWithoutAuth();
                await tester.TestCreateWithoutAuth();
                await tester.TestUpdateWithoutAuth();
                await tester.TestFakeAuthorizationHeaders();
                await tester.TestCSRFAttack();
                
                PrintResults(tester);
            }
            catch (Exception ex)
            {
                Console.ForegroundColor = ConsoleColor.Red;
                Console.WriteLine($"\n✗ Fatal Error: {ex.Message}");
                Console.ResetColor();
                Environment.Exit(2);
            }
        }

        static void PrintResults(AuthenticationSecurityTester tester)
        {
            Console.WriteLine("\n╔════════════════════════════════════════╗");
            Console.WriteLine("║        Test Results                     ║");
            Console.WriteLine("╚════════════════════════════════════════╝\n");

            if (tester.VulnerabilitiesFound == 0)
            {
                Console.ForegroundColor = ConsoleColor.Green;
                Console.WriteLine($"✓ SUCCESS: All {tester.TestsRun} tests passed!");
                Console.WriteLine("  The API is properly secured with authentication.");
                Console.ResetColor();
                Environment.Exit(0);
            }
            else
            {
                Console.ForegroundColor = ConsoleColor.Red;
                Console.WriteLine($"✗ FAILURE: {tester.VulnerabilitiesFound}/{tester.TestsRun} tests failed!");
                Console.WriteLine("  Security vulnerabilities detected:");
                Console.WriteLine($"  - {tester.VulnerabilitiesFound} endpoints are accessible without proper authentication");
                Console.ResetColor();
                Environment.Exit(1);
            }
        }
    }
}
