# Maltalisting Security Pentest Tool

A penetration testing tool to verify authentication security on the Maltalisting API.

## Overview

This tool simulates attacks from a "bad actor" trying to:
- Delete listings without authentication
- Create/update listings without authentication  
- Bypass authentication with fake headers
- Execute CSRF attacks
- Use copied browser headers to access protected resources

## Security Goals

✅ **DEV Environment (with auth)**: All tests should PASS (requests rejected with 401/403)
❌ **PROD Environment (without auth update)**: Tests should FAIL (vulnerabilities detected)

## Prerequisites

- .NET 8.0 SDK installed
- Network access to target API

## Build & Run

### Local Development

```bash
cd pentest
dotnet build
API_BASE_URL=http://localhost:5000 dotnet run
```

### Using the Deploy Script

From project root:

```bash
# Test production
./deploy/pentest-prod.sh

# Test preprod
./deploy/pentest-prod.sh https://preprod.maltalisting.com

# Test local dev
./deploy/pentest-prod.sh http://localhost:5000

# Skip rebuild
PENTEST_SKIP_BUILD=1 ./deploy/pentest-prod.sh https://maltalisting.com
```

## Test Cases

### 1. DELETE without auth
- **Endpoint**: `DELETE /api/listings/1`
- **Expected**: 401/403 response
- **PASS**: Request rejected
- **FAIL**: 404 or 200/204 (endpoint accessible)

### 2. POST (Create) without auth
- **Endpoint**: `POST /api/listings`
- **Expected**: 401/403 response
- **PASS**: Request rejected
- **FAIL**: 400 before auth check or 201 (endpoint accessible)

### 3. PUT (Update) without auth
- **Endpoint**: `PUT /api/listings/1`
- **Expected**: 401/403 response
- **PASS**: Request rejected
- **FAIL**: 400 before auth check or 200 (endpoint accessible)

### 4. Fake Authorization Headers
- **Method**: Send requests with fake Bearer tokens and custom headers
- **Expected**: 401/403 response
- **PASS**: Fake headers rejected
- **FAIL**: Request accepted with fake auth

### 5. CSRF Attack Simulation
- **Method**: Cross-origin DELETE request from evil.com
- **Expected**: 401/403 response
- **PASS**: CSRF attempt blocked
- **FAIL**: Request accepted

## Expected Results

### ✅ With Auth Enabled (DEV)

```
[TEST 1] DELETE /api/listings/1 without authentication
  ✓ PASS: 403 Forbidden - Authentication required

[TEST 2] POST /api/listings without authentication
  ✓ PASS: 403 Forbidden - Authentication required

[TEST 3] PUT /api/listings/1 without authentication
  ✓ PASS: 403 Forbidden - Authentication required

[TEST 4] DELETE with fake Bearer token
  ✓ PASS: 403 Forbidden - Authentication required

[TEST 5] CSRF - DELETE from evil.com origin
  ✓ PASS: 403 Forbidden - Authentication required

╔════════════════════════════════════════╗
║        Test Results                     ║
╚════════════════════════════════════════╝

✓ SUCCESS: All 5 tests passed!
  The API is properly secured with authentication.
```

Exit Code: `0` ✓

### ❌ Without Auth (PROD - Before Update)

```
[TEST 1] DELETE /api/listings/1 without authentication
  ✗ CRITICAL: 404 NotFound - ENDPOINT IS PUBLIC!
     Got 404 (not found) instead of 401 (unauthorized).
     This means authentication was NOT checked before lookup!

[TEST 2] POST /api/listings without authentication
  ✗ FAIL: 400 BadRequest - Auth not checked first
     Got validation error instead of 401 Unauthorized.
     Endpoint may be accessible to unauthenticated users.

[TEST 3] PUT /api/listings/1 without authentication
  ✗ FAIL: 400 BadRequest - Auth not checked first
     Got validation error instead of 401 Unauthorized.
     Endpoint may be accessible to unauthenticated users.

[TEST 4] DELETE with fake Bearer token
  ✗ CRITICAL: 404 NotFound - ENDPOINT IS PUBLIC!
     Got 404 (not found) instead of 401 (unauthorized).
     This means authentication was NOT checked before lookup!

[TEST 5] CSRF - DELETE from evil.com origin
  ✗ CRITICAL: 404 NotFound - ENDPOINT IS PUBLIC!
     Got 404 (not found) instead of 401 (unauthorized).
     This means authentication was NOT checked before lookup!

╔════════════════════════════════════════╗
║        Test Results                     ║
╚════════════════════════════════════════╝

✗ FAILURE: 5/5 tests failed!
  Security vulnerabilities detected:
  - 5 endpoints are accessible without proper authentication
```

Exit Code: `1` ✗

## Exit Codes

| Code | Meaning |
|------|---------|
| 0 | All security tests passed ✓ |
| 1 | Vulnerabilities found ✗ |
| 2 | Test execution error |

## Integration in CI/CD

Add to your pipeline to automatically verify security:

```bash
# Fails the build if vulnerabilities found
./deploy/pentest-prod.sh || exit 1
```

## Project Structure

```
pentest/
├── Program.cs                    Main entry point
├── AuthenticationSecurityTester.cs   Core test logic
├── MaltalistPentest.csproj      Project configuration
├── README.md                     This file
└── .gitignore
```

## Notes

- All tests are non-destructive and read-only
- Default timeout is 30 seconds per request
- SSL certificate validation is disabled for testing
- Tests check auth is enforced BEFORE resource lookup

## Future Enhancements

- [ ] Test for SQL injection vulnerabilities
- [ ] Test for XSS in API responses
- [ ] Validate proper error message sanitization
- [ ] Test for rate limiting bypass
- [ ] Check for information disclosure in error responses
- [ ] Verify CORS policy enforcement
- [ ] Test JWT token validation

## Author

Maltalisting Security Team

## License

Internal Use Only

