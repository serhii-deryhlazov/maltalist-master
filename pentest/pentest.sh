#!/bin/bash

# Pentest Script - Run security tests against API
# Usage: ./pentest.sh [STAGE]
#        ./pentest.sh prod
#        ./pentest.sh dev

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Default values
STAGE="${1:-prod}"
PENTEST_DIR="$(pwd)"

# Stage to URL mapping
get_api_url() {
    case "$1" in
        prod)
            echo "https://maltalisting.com"
            ;;
        preprod)
            echo "https://preprod.maltalisting.com"
            ;;
        dev)
            echo "http://localhost:5000"
            ;;
        *)
            return 1
            ;;
    esac
}

show_usage() {
    echo "Usage: $0 [STAGE]"
    echo ""
    echo "Arguments:"
    echo "  STAGE        Target stage: prod, preprod, or dev (default: prod)"
    echo ""
    echo "Examples:"
    echo "  $0           # Test production"
    echo "  $0 prod      # Test production (https://maltalisting.com)"
    echo "  $0 preprod   # Test preprod (https://preprod.maltalisting.com)"
    echo "  $0 dev       # Test local dev (http://localhost:5000)"
}

# Parse arguments
if [[ "$1" == "-h" || "$1" == "--help" ]]; then
    show_usage
    exit 0
fi

# Validate stage and get API URL
API_URL=$(get_api_url "$STAGE")
if [ $? -ne 0 ]; then
    echo -e "${RED}Error: Invalid stage '$STAGE'${NC}"
    show_usage
    exit 1
fi

# Check if pentest project exists
if [ ! -f "$PENTEST_DIR/MaltalistPentest.csproj" ]; then
    echo -e "${RED}Error: pentest project not found at $PENTEST_DIR${NC}"
    echo "Make sure you're running this from the project root or deploy directory"
    exit 1
fi

# Build the pentest project if needed
if [[ "$PENTEST_SKIP_BUILD" != "1" ]]; then
    echo -e "${BLUE}=== Building Pentest Project ===${NC}"
    cd "$PENTEST_DIR"
    
    if ! dotnet build -q; then
        echo -e "${RED}Build failed!${NC}"
        exit 1
    fi
    
    echo -e "${GREEN}✓ Build successful${NC}"
else
    echo -e "${YELLOW}⏭  Skipping build (PENTEST_SKIP_BUILD=1)${NC}"
fi

echo ""
echo -e "${BLUE}╔════════════════════════════════════════╗${NC}"
echo -e "${BLUE}║        Running Security Pentest        ║${NC}"
echo -e "${BLUE}╚════════════════════════════════════════╝${NC}"
echo ""
echo -e "Target URL: ${YELLOW}$API_URL${NC}"
echo ""

# Run the pentest
cd "$PENTEST_DIR"
API_BASE_URL="$API_URL" dotnet run -q

RESULT=$?

echo ""
echo -e "${BLUE}╔════════════════════════════════════════╗${NC}"
echo -e "${BLUE}║          Pentest Results               ║${NC}"
echo -e "${BLUE}╚════════════════════════════════════════╝${NC}"
echo ""

if [ $RESULT -eq 0 ]; then
    echo -e "${GREEN}✓ PASS: All security tests passed!${NC}"
    echo "  The API is properly protected."
    exit 0
elif [ $RESULT -eq 1 ]; then
    echo -e "${RED}✗ FAIL: Vulnerabilities detected!${NC}"
    echo "  The API has security issues that need to be fixed."
    exit 1
else
    echo -e "${RED}✗ ERROR: Test execution failed${NC}"
    echo "  Exit code: $RESULT"
    exit $RESULT
fi
